<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>写真台帳作成ツール</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- 日本語フォントを追加 -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.12.313/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.12.313/build/pdf.worker.min.js"></script>
    <style>
        @media print {
            .photo-item {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <!-- 前回と同じ body 部分 -->
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
        <!-- 以前と同じコンテンツ部分 -->
    </div>

    <script>
        // jsPDFの設定を変更
        const { jsPDF } = window.jspdf;

        // 日本語フォントの設定
        const loadJapaneseFont = async () => {
            const font = await fetch('https://cdn.jsdelivr.net/npm/@fontsource/noto-sans-jp@4.5.12/files/noto-sans-jp-all-400-normal.woff')
                .then(response => response.arrayBuffer());
            return font;
        };

        // PDF生成関数を更新
        async function generatePDF() {
            if (photos.length === 0) {
                alert('写真をアップロードしてください。');
                return;
            }

            try {
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 10;
                const imageWidth = (pageWidth - (margin * 3)) / 2;
                const imageHeight = (pageHeight - (margin * 4)) / 3;
                const photosPerPage = 6;

                // フォントの設定
                doc.addFileToVFS('NotoSansJP-Regular.ttf', await loadJapaneseFont());
                doc.addFont('NotoSansJP-Regular.ttf', 'NotoSansJP', 'normal');
                doc.setFont('NotoSansJP');

                for (let i = 0; i < photos.length; i++) {
                    if (i > 0 && i % photosPerPage === 0) {
                        doc.addPage();
                    }

                    const pageIndex = i % photosPerPage;
                    const col = pageIndex % 2;
                    const row = Math.floor(pageIndex / 2);

                    const x = margin + (col * (imageWidth + margin));
                    const y = margin + (row * (imageHeight + margin));

                    // 画像の追加
                    doc.addImage(
                        photos[i].url,
                        'JPEG',
                        x,
                        y,
                        imageWidth,
                        imageHeight - 20
                    );

                    // テキスト情報の追加（日本語対応）
                    doc.setFontSize(8);
                    const textY = y + imageHeight - 18;
                    doc.text(`設備: ${photos[i].equipment || '-'}`, x, textY);
                    doc.text(`場所: ${photos[i].location || '-'}`, x, textY + 4);
                    doc.text(`状態: ${photos[i].status || '-'}`, x, textY + 8);
                    doc.text(`説明: ${photos[i].description || '-'}`, x, textY + 12);

                    // ページ番号を追加
                    const pageNum = Math.floor(i / photosPerPage) + 1;
                    const totalPages = Math.ceil(photos.length / photosPerPage);
                    doc.setFontSize(8);
                    doc.text(
                        `${pageNum} / ${totalPages}`,
                        pageWidth - margin - 15,
                        pageHeight - margin
                    );
                }

                // PDFを保存
                doc.save(`写真台帳_${new Date().toISOString().slice(0,10)}.pdf`);

            } catch (error) {
                console.error('PDF生成エラー:', error);
                alert('PDFの生成中にエラーが発生しました。');
            }
        }

        // 他の関数は前回と同じ
        // handleImageUpload, resizeImage, updatePhotosGrid, updatePhotoInfo, removePhoto
    </script>
</body>
</html>
